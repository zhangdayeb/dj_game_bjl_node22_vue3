// src/stores/bettingHistoryStore.ts - ç®€åŒ–ç‰ˆ
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { getGlobalApiService } from '@/services/gameApi'
import type { BettingHistoryParams, BettingHistoryItem } from '@/services/gameApi'

// ç®€åŒ–çš„æŠ•æ³¨è®°å½•ç±»å‹ - åŸºäº API å“åº”æ ¼å¼
export interface BettingRecord {
  id: string                  // æ³¨å•å·
  xue_number: string          // é´å·
  pu_number: string           // é“ºå·
  bet_amt: number            // ä¸‹æ³¨é‡‘é¢
  win_amt: number            // ä¸­å¥–é‡‘é¢
  delta_amt: number          // å˜åŒ–é‡‘é¢
  detail: string             // æŠ•æ³¨æ˜ç»†JSON
  result: string             // æ¸¸æˆç»“æœ
  close_status: number       // ç»“æŸçŠ¶æ€
  created_at: string         // åˆ›å»ºæ—¶é—´
}

export const useBettingHistoryStore = defineStore('bettingHistory', () => {
  // æ ¸å¿ƒçŠ¶æ€
  const records = ref<BettingRecord[]>([])
  const currentPage = ref(1)
  const hasMore = ref(true)
  const loading = ref(false)
  const error = ref<string | null>(null)

  // å›ºå®šæ¯é¡µå¤§å°
  const pageSize = 20

  // è®¡ç®—å±æ€§
  const isEmpty = computed(() => records.value.length === 0)
  const isLoading = computed(() => loading.value)
  const canLoadMore = computed(() => hasMore.value && !loading.value && !error.value)

  // åŸºæœ¬ç»Ÿè®¡
  const basicStats = computed(() => {
    if (records.value.length === 0) {
      return {
        totalBet: 0,
        totalWin: 0,
        netAmount: 0,
        totalGames: 0
      }
    }

    const totalBet = records.value.reduce((sum, record) => {
      const betAmount = typeof record.bet_amt === 'number' ? record.bet_amt : 0
      return sum + betAmount
    }, 0)

    const totalWin = records.value.reduce((sum, record) => {
      const winAmount = typeof record.win_amt === 'number' ? record.win_amt : 0
      return sum + winAmount
    }, 0)

    const netAmount = records.value.reduce((sum, record) => {
      const deltaAmount = typeof record.delta_amt === 'number' ? record.delta_amt : 0
      return sum + deltaAmount
    }, 0)

    const totalGames = records.value.length

    return {
      totalBet,
      totalWin,
      netAmount,
      totalGames
    }
  })

  // åŠ è½½è®°å½•
  const loadRecords = async (page: number = 1, append: boolean = false): Promise<void> => {
    try {
      console.log(`ğŸ“š åŠ è½½æŠ•æ³¨è®°å½• - é¡µç : ${page}, è¿½åŠ : ${append}`)

      loading.value = true
      error.value = null

      const apiService = getGlobalApiService()
      const gameParams = apiService.getGameParams()

      const params: BettingHistoryParams = {
        user_id: parseInt(gameParams.user_id),
        table_id: gameParams.table_id,
        game_type: parseInt(gameParams.game_type),
        page,
        page_size: pageSize
      }

      const response = await apiService.getBettingHistory(params)

      console.log('ğŸ“¥ API å“åº”:', response)

      // ä½¿ç”¨ API è¿”å›çš„æ•°æ®æ ¼å¼
      const newRecords = response.items || []

      // æ•°æ®æ¸…æ´— - é€‚é… API è¿”å›çš„æ ¼å¼
      const cleanedRecords: BettingRecord[] = newRecords.map((record: BettingHistoryItem) => ({
        id: record.id,
        xue_number: record.xue_number,
        pu_number: record.pu_number,
        bet_amt: record.bet_amt,
        win_amt: record.win_amt,
        delta_amt: record.delta_amt,
        detail: record.detail,
        result: record.result,
        close_status: record.close_status,
        created_at: record.created_at
      }))

      // æ›´æ–°è®°å½•
      if (append && page > 1) {
        records.value = [...records.value, ...cleanedRecords]
        console.log('â• è¿½åŠ è®°å½•ï¼Œæ€»æ•°é‡:', records.value.length)
      } else {
        records.value = cleanedRecords
        console.log('ğŸ”„ æ›¿æ¢è®°å½•ï¼Œæ–°æ•°é‡:', cleanedRecords.length)
      }

      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      currentPage.value = page
      hasMore.value = response.has_next || false

      console.log('âœ… è®°å½•åŠ è½½å®Œæˆ', {
        currentPage: currentPage.value,
        hasMore: hasMore.value,
        totalRecords: records.value.length
      })

    } catch (err: any) {
      console.error('âŒ åŠ è½½æŠ•æ³¨è®°å½•å¤±è´¥:', err)
      error.value = err.message || 'åŠ è½½å¤±è´¥'
    } finally {
      loading.value = false
    }
  }

  // åŠ è½½æ›´å¤š
  const loadMore = async (): Promise<void> => {
    if (!canLoadMore.value) {
      console.log('âš ï¸ æ— æ³•åŠ è½½æ›´å¤š')
      return
    }

    console.log('ğŸ“„ åŠ è½½æ›´å¤šè®°å½•')
    await loadRecords(currentPage.value + 1, true)
  }

  // åˆ·æ–°
  const refresh = async (): Promise<void> => {
    console.log('ğŸ”„ åˆ·æ–°æŠ•æ³¨è®°å½•')
    currentPage.value = 1
    hasMore.value = true
    await loadRecords(1, false)
  }

  // æ¸…é™¤é”™è¯¯
  const clearError = (): void => {
    error.value = null
  }

  // æ ¼å¼åŒ–é‡‘é¢
  const formatAmount = (amount: number): string => {
    return amount.toLocaleString()
  }

  // æ ¼å¼åŒ–æ—¶é—´
  const formatTime = (timeString: string): string => {
    const date = new Date(timeString)
    return date.toLocaleString('zh-CN')
  }

  // åˆå§‹åŒ–
  const init = async (): Promise<void> => {
    console.log('ğŸ“š æŠ•æ³¨å†å² Store åˆå§‹åŒ–')

    // é‡ç½®çŠ¶æ€
    records.value = []
    currentPage.value = 1
    hasMore.value = true
    loading.value = false
    error.value = null

    // åŠ è½½åˆå§‹æ•°æ®
    try {
      await loadRecords(1, false)
      console.log('âœ… æŠ•æ³¨å†å²åˆå§‹åŒ–å®Œæˆ')
    } catch (err) {
      console.error('âŒ æŠ•æ³¨å†å²åˆå§‹åŒ–å¤±è´¥:', err)
    }
  }

  return {
    // çŠ¶æ€
    records,
    currentPage,
    hasMore,
    loading,
    error,

    // è®¡ç®—å±æ€§
    isEmpty,
    isLoading,
    canLoadMore,
    basicStats,

    // æ–¹æ³•
    loadRecords,
    loadMore,
    refresh,
    clearError,
    formatAmount,
    formatTime,
    init
  }
})
